<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>数据导入导出管理</title>
    <link rel="stylesheet" href="/css/element-ui.css">
    <style>
        .container {
            padding: 20px;
        }
        .upload-demo {
            margin-bottom: 20px;
        }
        .table-operations {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="app" class="container">
        <el-button type="danger" style="float: right; margin-bottom: 20px;" @click="logout">退出登录</el-button>
        <el-card>
            <div slot="header">
                <span>数据导入</span>
            </div>
            <el-upload
                class="upload-demo"
                :action="'/previewFile'"
                :data="uploadData"
                :on-success="handlePreviewSuccess"
                :on-error="handleUploadError"
                :auto-upload="true"
                :show-file-list="false">
                <el-button size="small" type="primary">选择文件</el-button>
                <div slot="tip" class="el-upload__tip">只能上传xlsx/xls/csv文件</div>
            </el-upload>
            <el-radio-group v-model="uploadData.dataSource">
                <el-radio label="MYSQL">MySQL</el-radio>
                <el-radio label="MONGODB">MongoDB</el-radio>
                <el-radio label="BOTH">Both</el-radio>
            </el-radio-group>

            <div v-if="previewData.length > 0" style="margin-top: 20px;">
                <h3>数据预览</h3>
                <el-table
                    v-loading="previewLoading"
                    :data="previewData"
                    border
                    style="width: 100%">
                    <el-table-column
                        v-for="header in previewHeaders"
                        :key="header"
                        :prop="header"
                        :label="header">
                    </el-table-column>
                </el-table>
                <el-pagination
                    @current-change="handlePreviewPageChange"
                    :current-page="previewPage"
                    :page-size="previewPageSize"
                    :total="previewTotal"
                    layout="total, prev, pager, next"
                    style="margin-top: 10px;">
                </el-pagination>
                
                <div style="margin-top: 20px; text-align: center;">
                    <el-button type="primary" @click="confirmImport" :loading="importing">
                        确认导入
                    </el-button>
                    <el-button @click="cancelImport">取消</el-button>
                </div>
            </div>
        </el-card>

        <el-card style="margin-top: 20px;">
            <div slot="header">
                <span>数据管理</span>
            </div>
            <div class="table-operations">
                <el-radio-group v-model="currentDataSource" @change="handleDataSourceChange">
                    <el-radio label="MYSQL">MySQL</el-radio>
                    <el-radio label="MONGODB">MongoDB</el-radio>
                </el-radio-group>
                <el-select v-model="currentTable" placeholder="请选择表" @change="loadTableData">
                    <el-option
                        v-for="table in tables"
                        :key="table"
                        :label="table"
                        :value="table">
                    </el-option>
                </el-select>
                <el-button type="success" @click="exportToExcel" :disabled="!currentTable">导出Excel</el-button>
                <el-button type="success" @click="exportToCsv" :disabled="!currentTable">导出CSV</el-button>
            </div>
            
            <el-table
                v-loading="loading"
                :data="tableData"
                border
                style="width: 100%">
                <el-table-column
                    v-for="header in tableHeaders"
                    :key="header"
                    :prop="header"
                    :label="header">
                </el-table-column>
            </el-table>
            <el-pagination
                @current-change="handleCurrentChange"
                :current-page="currentPage"
                :page-size="pageSize"
                :total="total"
                layout="total, prev, pager, next">
            </el-pagination>
        </el-card>
    </div>

    <script src="/js/vue.min.js"></script>
    <script src="/js/element-ui.js"></script>
    <script src="/js/axios.min.js"></script>
    <script>
        new Vue({
            el: '#app',
            data: {
                uploadUrl: '/uploadDynamicFile',
                uploadData: {
                    dataSource: 'MYSQL'
                },
                currentDataSource: 'MYSQL',
                currentTable: '',
                tables: [],
                tableData: [],
                tableHeaders: [],
                loading: false,
                currentPage: 1,
                pageSize: 10,
                total: 0,
                previewData: [],
                previewHeaders: [],
                previewPage: 1,
                previewPageSize: 10,
                previewTotal: 0,
                previewLoading: false,
                importing: false,
                previewFileName: '',
                previewFileContent: null
            },
            created() {
                this.loadTables();
            },
            methods: {
                handleUploadError() {
                    this.$message.error('上传失败');
                },
                handlePreviewSuccess(response) {
                    if (response.success) {
                        this.previewHeaders = response.headers;
                        this.previewData = response.content;
                        this.previewTotal = response.total;
                        this.previewFileName = response.fileId;
                        console.log('Preview file ID:', this.previewFileName);
                    } else {
                        this.$message.error(response.message || '预览失败');
                    }
                },
                handlePreviewPageChange(page) {
                    this.previewPage = page;
                    this.loadPreviewData();
                },
                loadPreviewData() {
                    this.previewLoading = true;
                    axios.get(`/previewData`, {
                        params: {
                            fileName: this.previewFileName,
                            page: this.previewPage,
                            size: this.previewPageSize
                        }
                    })
                    .then(response => {
                        this.previewData = response.data.content;
                        this.previewTotal = response.data.total;
                    })
                    .catch(() => {
                        this.$message.error('加载预览数据失败');
                    })
                    .finally(() => {
                        this.previewLoading = false;
                    });
                },
                confirmImport() {
                    if (!this.previewFileName) {
                        this.$message.error('没有可导入的文件');
                        return;
                    }

                    this.importing = true;
                    const requestData = {
                        fileName: this.previewFileName,
                        dataSource: this.uploadData.dataSource
                    };
                    console.log('Importing with data:', requestData);
                    
                    axios.post('/confirmImport', requestData)
                        .then(response => {
                            this.$message.success('导入成功');
                            this.previewData = [];
                            this.previewHeaders = [];
                            this.previewFileName = '';
                            this.loadTables();
                        })
                        .catch(error => {
                            console.error('Import error:', error);
                            this.$message.error(error.response?.data?.error || '导入失败');
                        })
                        .finally(() => {
                            this.importing = false;
                        });
                },
                cancelImport() {
                    this.previewData = [];
                    this.previewHeaders = [];
                    axios.post('/cancelImport', {
                        fileName: this.previewFileName
                    });
                },
                loadTables() {
                    axios.get(`/tables?dataSource=${this.currentDataSource}`)
                        .then(response => {
                            this.tables = response.data;
                        })
                        .catch(() => {
                            this.$message.error('加载表列表失败');
                        });
                },
                handleDataSourceChange() {
                    this.currentTable = '';
                    this.tableData = [];
                    this.tableHeaders = [];
                    this.loadTables();
                },
                loadTableData() {
                    if (!this.currentTable) return;
                    
                    this.loading = true;
                    axios.get(`/data?tableName=${this.currentTable}&dataSource=${this.currentDataSource}&page=${this.currentPage}&size=${this.pageSize}`)
                        .then(response => {
                            this.tableData = response.data.content;
                            this.total = response.data.total;
                            this.tableHeaders = response.data.headers;
                        })
                        .catch(() => {
                            this.$message.error('加载数据失败');
                        })
                        .finally(() => {
                            this.loading = false;
                        });
                },
                handleCurrentChange(page) {
                    this.currentPage = page;
                    this.loadTableData();
                },
                exportToExcel() {
                    window.location.href = `/exportToExcel?tableName=${this.currentTable}&dataSource=${this.currentDataSource}`;
                },
                exportToCsv() {
                    window.location.href = `/exportToCsv?tableName=${this.currentTable}&dataSource=${this.currentDataSource}`;
                },
                logout() {
                    window.location.href = '/logout';
                }
            }
        });
    </script>
</body>
</html> 